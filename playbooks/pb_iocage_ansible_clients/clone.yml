- name: Create clones from template
  register: out_create
  vars:
    _notes: '{{ [properties.notes | d(""),
                 item.value.properties.notes | d("")] | select | join(" ") }}'
    _properties: '{{ [properties | d({}),
                      item.value.properties | d({}),
                      {"notes": _notes}] | select | combine(recursive=true) }}'
  vbotka.freebsd.iocage:
    state: cloned
    clone_from: "{{ item.value.clone_from }}"
    name: "{{ item.key }}"
    properties: "{{ _properties }}"
  loop: "{{ clones | dict2items }}"
  loop_control:
    label: "{{ item.key }} {{ item.value.clone_from }}"

- name: "Debug clones from template debug2={{ debug2 }}"
  when: debug2 | bool
  ansible.builtin.debug:
    var: out_create

# - name: Start clones
#   register: out_start
#   vbotka.freebsd.iocage:
#     state: started
#     name: "{{ item }}"
#   loop: "{{ start }}"

- name: Start clones  # noqa: no-changed-when
  register: out_start
  ansible.builtin.command:
    cmd: >
      iocage start
      {{ start | join(' ') }}

- name: "Debug start clones debug2={{ debug2 }}"
  when: debug2 | bool
  ansible.builtin.debug:
    var: out_start

# Note
#
# The string _notes is not quoted (compare with swarm.yml) because the module vbotka.freebsd.iocage
# quotes the properties values. See the function _props_to_str in
# https://github.com/vbotka/ansible-collection-freebsd/blob/master/plugins/modules/iocage.py
